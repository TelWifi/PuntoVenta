var Form={CITEMS:0,CPRODUCTO:1,CPRECIO:2,CCANT:3,CSUBT:4,CBTNELI:5,Tabla:"#tabla-factura",Und:"#undatencion",Div:"#divatencion",UndDesc:"#undatencion-desc",PerDesc:"#peratencion-desc",FormCambiarUnd:"#modal-cambiar-undatencion",FormSelectDiv:"#modal-cambiar-divatencion",getIGV:function(){$.ajax({type:"post",dataType:"json",cache:false,url:"/Parreg/ObtenerIGV",data:{},success:function(a,b,c){if("ERROR"==a.respuesta.toString().split(":")[0])alert(a.respuesta);else if("EXITO"==a.respuesta.toString().split(":")[0])void 0!=parseFloat(a.igv)?Form.IGV=parseFloat(a.igv):Form.IGV=18},error:function(a,b){errorAjax(a,b)}})}};function removeRow(a,b){$.ajax({type:"post",dataType:"json",cache:false,url:"/Cond/Eliminar",data:{codigo:$(Form.Tabla).data("codigo"),item:a.data("item")},success:function(c,d,e){if("ERROR"==c.respuesta.toString().split(":")[0])return alert(c.respuesta);a.remove();actualizarTotal(b,Form.CSUBT);actualizarItems(b,Form.CITEMS)},error:function(a,b){errorAjax(a,b)}})}function updateRow(a,b){var c=a.find("td input[type=number]");$.ajax({type:"post",dataType:"json",cache:false,url:"/Cond/Actualizar",data:{codigo:$(Form.Tabla).data("codigo"),item:a.data("item"),cantidad:c.val()},success:function(d,e,f){if("ERROR"==d.respuesta.toString().split(":")[0])return alert(d.respuesta);actualizarSubtotal(a,c,Form.CPRECIO,Form.CSUBT);actualizarTotal(b,Form.CSUBT)},error:function(a,b){errorAjax(a,b)}})}function resetTabla(a){$(a).find("tbody tr").remove();$(a).data("codigo","");$(a+"-items").text("-");$(a+"-igv").text("-");$(a+"-total").text("-");$(a+"-sel-items").text("-");$(a+"-sel-total").text("-");$(a+"-sel-igv").text("-")}function guardarFactura(a){if(!Validar.Dato(a.data("codigo")))return alert(Msg.NO_EXISTE.replace("el c\u00F3digo del consumo"));var b=a.data("codigo");var c=new Array();a.find("tbody tr").each(function(a){var b={CANTIDAD:parseFloat($(this).find("td input[type=number]").val()),CONVENTA:$(this).data("codigo"),ITEM:$(this).find("td").get(Form.CITEMS).innerHTML};c.push(b)});$.ajax({type:"post",dataType:"json",cache:false,url:"/Cond/Guardar",data:{codigo:b,items:JSON.stringify(c)},success:function(a,b,c){alert(a.respuesta)},error:function(a,b){errorAjax(a,b)}})}function agregarProducto(a){var b=App.getInputCantidad();$.ajax({type:"post",dataType:"json",cache:false,url:"/Cond/Crear",data:{codigo:$(Form.Tabla).data("codigo"),cantidad:b.val(),conventa:a.data("codigo")},success:function(c,d,e){if("ERROR"==c.respuesta.toString().split(":")[0])return alert(c.respuesta);var f="#tabla-factura";var g=App.getBtnRemove();var h=a.find(".nombre").first().text();var i=parseFloat(a.data("precio")).toFixed(2);var j=[$(f).find("tr").length,h,i,b,i,g];var k=addRow($(f),j);k.data("item",c.item);k.data("codigo",a.data("codigo"));actualizarTotal(f,Form.CSUBT);actualizarItems(f,Form.CITEMS);g.on("click",function(){removeRow(k,f)});b.change(function(){var a=parseFloat($(this).val());if(a>0)updateRow(k,Form.Tabla);else{$(this).val(1);updateRow(k,Form.Tabla);alert(Msg.CANT_NO_MENOR_A.replace("{text}","una unidad"))}})},error:function(a,b){errorAjax(a,b)}})}function obtenerDetalle(a,b,c,d,e,f){if(!Validar.Dato(a.val())||!Validar.Dato(b)||!Validar.Dato(c))return;if(!Validar.StrSoloNum(a.val()))return alert(Msg.ERROR_CAMPO_NUMERICO.replace("<attr>","La unidad de atenci\u00F3n"));$.ajax({type:"post",dataType:"json",cache:false,url:"/Cond/Obtener",data:{codund:a.val(),coddiv:b},success:function(b,g,h){clearDesc(d,e);resetTabla(c);if(App.isError(b.respuesta))alert(b.respuesta);else if(App.isExito(b.respuesta)){$(e).data("codigo",b.undatencion.CODIGO);$(e).text(b.undatencion.DESCRIPCION);$(c).data("codigo",b.cabecera.CODIGO);$(d).data("codigo",b.peratencion.codigo);$(d).text(b.peratencion.descripcion);$.each(b.lista,function(a,b){var d=App.getInputCantidad();var e=App.getBtnRemove();var f=[$(c).find("tr").length,b["DESCRIPCION"],parseFloat(b["PREUNI"]).toFixed(2),d,parseFloat(b["TOTAL"]).toFixed(2),e];var g=addRow($(c),f);g.data("codigo",b["CONVENTA"]);g.data("item",b["ITEM"]);e.on("click",function(){removeRow(g,c)});d.change(function(){var a=parseFloat($(this).val());if(a>0)updateRow(g,c);else{$(this).val(1);updateRow(g,c);alert(Msg.CANT_NO_MENOR_A.replace("{text}","una unidad"))}});$(c).append(g)});actualizarTotal(c,Form.CSUBT);actualizarItems(c,Form.CITEMS)}else if(App.isAdvert(b.respuesta))f(a)},error:function(a,b){errorAjax(a,b)}})}function changeUndAtencion(a){if(Validar.Dato($(Form.Div).val()))if(Validar.Dato(a.val()))obtenerDetalle(a,$(Form.Div).val(),Form.Tabla,Form.PerDesc,Form.UndDesc,function(a){if(confirm(MSG_DESEA_APERTURAR))$("#modal-seleccionar-peratencion").modal("show")});else alert(Msg.SELECCION_UND);else{$(this).val("");alert(Msg.SELECCION_DIV)}}$(document).ready(function(){$(Form.Div).on("change",function(){$(Form.Und).val("");resetTabla(Form.Tabla);clearDesc(Form.PerDesc,Form.UndDesc)});$(Form.Und).keypress(function(a){if(13==a.which)changeUndAtencion($(this))});$("#undatencion").bind("accepted",function(a,b,c){changeUndAtencion($(this))});obtenerDetalle($(Form.Und),$(Form.Div).val(),Form.Tabla,Form.PerDesc,Form.UndDesc,function(a){});if("ACT"==$(App.ControlTeclado+":checked").val()){$("input[type='text']").keyboard();tecladoNumerico($("input[type='number']"))}$("#cambiar-undatencion").on("click",function(){if(!Validar.Dato($(Form.Div).val()))return alert(Msg.SELECCION_DIV);if(!Validar.Dato($(Form.Tabla).data("codigo")))return alert(Msg.SELECCION_UND);$(Form.FormCambiarUnd).modal("show");$(Form.FormSelectDiv).val($(Form.Div).val());$(Form.FormSelectDiv).change()});$(Form.FormSelectDiv).on("change",function(){buscarAjax("/UndAtencion/ObtenerLibres",$(this).val(),$("#tabla-cambiar-undatencion"),["CODIGO","DESCRIPCION"],function(a){a.on("click",function(){if(confirm(MSG_DESEA_CAMBIAR_UNDATENCION)){var a=$(this).find("td").get(0).innerHTML;var b=$(Form.FormSelectDiv).val();var c=$(Form.Tabla).data("codigo");cambiarUndatencion(c,$(Form.Und),$(Form.Div),a,b,$(Form.UndDesc));$(Form.FormCambiarUnd).modal("hide")}})})});$("#factura-pre-factura").on("click",function(){if(!Validar.Dato($(Form.Div).val()))return alert(Msg.SELECCION_DIV);if(!Validar.Dato($(Form.Tabla).data("codigo")))return alert(Msg.SELECCION_UND);var a=$(Form.Tabla);if(a.find("tbody tr").length<=0)return alert(Msg.SIN_ELEMENTOS);printPreFactura(a)});$("#empleados li").on("click",function(){$("#modal-seleccionar-peratencion").modal("hide");var a=$(this);$.ajax({type:"post",dataType:"json",cache:false,url:"/UndAtencion/Aperturar",data:{codigo:$(Form.Und).val(),idperatencion:$(this).data("codigo"),divate:$(Form.Div).val()},success:function(b,c,d){if("ERROR"==b.respuesta.toString().split(":")[0])alert(b.respuesta);else{$(Form.Tabla).data("codigo",b.cabecera.CODIGO);$(Form.UndDesc).text(b.undatencion.DESCRIPCION);$(Form.UndDesc).data("codigo",b.undatencion.CODIGO);$(Form.PerDesc).data("codigo",$(this).data("codigo"));$(Form.PerDesc).text(a.data("desc"))}},error:function(a,b){errorAjax(a,b)}})});$("#factura-btn-guardar").on("click",function(){if(!Validar.Dato($(Form.Div).val()))return alert(Msg.SELECCION_DIV);if(!Validar.Dato($(Form.Tabla).data("codigo")))return alert(Msg.SELECCION_UND);guardarFactura($(Form.Tabla))});$(".seleccion-categoria").on("click",function(){var a=$(this).data("codigo");buscarConventaClaserv(a,$("#panel-productos-"+a),Form.Tabla)});$("#conventa-btn-buscar").on("click",function(){buscarConventaDescripcion($("#conventa-texto").val(),$("#panel-buscar"),Form.Tabla)});$("#conventa-texto").on("keyup",function(a){buscarConventaDescripcion($("#conventa-texto").val(),$("#panel-buscar"),Form.Tabla)});$("#conventa-texto").bind("accepted",function(a,b,c){buscarConventaDescripcion($("#conventa-texto").val(),$("#panel-buscar"),Form.Tabla)})});